{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load static %}
{% block content %}
  <div class="container mt-3">
    {% if request.user != user %}
      <h1 class="main_color1 fw-bold mt-3 mb-3 text-center"><img src="{% static '/images/logo.png' %}" style="width:58px; height:58px;">
        {{ user.username }}ë‹˜ì˜ í˜ì´ì§€</h1>
    {% else %}
      <h1 class="main_color1 fw-bold mt-3 mb-3 text-center"><img src="{% static '/images/logo.png' %}" style="width:58px; height:58px;">
        ë§ˆì´í˜ì´ì§€</h1>
    {% endif %}
    <hr>

    <div class="row mt-5">
      <!-- ì™¼ìª½ í™”ë©´ -->
      <div class="col-5">
        <h4 class="main_color2 mb-3 fw-bold text-center">í”„ë¡œí•„</h4>
        <p class="text-center">
          {% if user.profile %}
            <img class='rounded-circle' style='height:180px;width:180px;' src="{{ user.profile.url }}" alt="{{ user.profile }}">
          {% else %}
            <img class='rounded-circle' style='height:180px;width:180px;' src="{% static '/images/profile/user.png'%}" alt="user">
          {% endif %}
        </p>
        <div class="text-center mt-3">
          <span>
            <span class="fw-bold main_color1">
              <a class="fw-bold main_color1" href="{% url 'accounts:follow_page' user.pk%}" style="text-decoration: none;">íŒ”ë¡œì‰ ìˆ˜</a>
            </span>
            <span class="text-muted" id="followings-count">{{ user.follow.count }}&nbsp&nbsp</span>
            <span class="fw-bold main_color1">
              <a class="fw-bold main_color1" href="{% url 'accounts:follow_page' user.pk%}" style="text-decoration: none;">íŒ”ë¡œì›Œ ìˆ˜</a>
            </span>
            <span class="text-muted" id="followers-count">{{ user.followers.count }}
            </span>
          </span>
        </div>
        <!-- follow/following -->
        <div class="text-center mt-1 mb-1">
          {% if request.user != user %}
            <form id='follow-form' data-user-id="{{user.pk}}" method='POST'>
              {% csrf_token %}
              {% if request.user in user.followers.all %}
                <input type="submit" value="ì´ ì‚¬ìš©ìë¥¼ UnFollow í•˜ê² ì–´ìš”." class='btn btn-sm login_btn fw-bold'>
              {% else %}
                <input type="submit" value="ì´ ì‚¬ìš©ìë¥¼ Follow í• ë˜ìš”!" class='btn btn-sm signup_btn fw-bold'>
              {% endif %}
            </form>
          {% endif %}
        </div>

        <!-- ìª½ì§€ ë³´ë‚´ê¸° ë²„íŠ¼ -->
        <div class="text-center mt-3 mb-3">
          {% if request.user == user %}
            <a class='btn login_btn ms-auto position-relative' href="{%url 'accounts:note' %}" target="_blank" onclick="window.open(this.href, '', 'width=500, height=430 left=100px,top=100px'); return false;">
              <i class="bi bi-envelope"></i>
              ìª½ì§€í•¨
              {% if note_count.count != 0 %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                  {{ note_count.count }}
                <span class="visually-hidden">unread messages</span>
              {% endif %}
              </span>
            </a>
          {% endif %}
        </div>

        <div style="margin: 0 auto; width:50%;">
          {% if user.githuburl %}
            <p class="main_color1"><img style='height:30px;width:30px;' src="{% static '/images/github.png'%}">
              <a class="fw-bold" href="{{user.githuburl}}">
                {{ user.githuburl }}
              </a>
            </p>
          {% else %}
            <p class="main_color1"><img style='height:30px;width:30px;' src="{% static '/images/github.png'%}">
              {% if request.user == user %}
                <a href="{% url 'accounts:update' %}" style="text-decoration:none;" class="main_color2">
                  Github ì£¼ì†Œë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.</a>
              {% else %}
                Github ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.
              {% endif %}
            </p>
          {% endif %}

          {% if user.email %}
            <p class="main_color1 fw-bold"><img style='height:30px;width:30px;' src="{% static '/images/email.png'%}">
              {{ user.email }}</p>
          {% else %}
            <p class="main_color2"><img style='height:30px;width:30px;' src="{% static '/images/email.png'%}">
              {% if request.user == user %}
                <a href="{% url 'accounts:update' %}" style="text-decoration:none;" class="main_color2">
                  ì´ë©”ì¼ ì£¼ì†Œë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.</a>
              {% else %}
                ì´ë©”ì¼ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.
              {% endif %}
            </p>
          {% endif %}

          <!-- user.post íƒœê·¸ ë¹ˆë„ìˆ˜ ë†’ì€ ìˆœ ì„¸ê°œ í˜¸ì¶œ -->
          <p class="main_color1"><img style='height:30px;width:30px;' src="{% static '/images/tag.png'%}">
            {% for tag in tagfreq %}
              #{{ tag.tag }}
            {% endfor %}
          </p>

        </div>
        {% if delta.years == 0 %}
          <p class="text-center fw-bold mt-3"><img style='height:45px;width:45px;' src="{% static '/images/0.png'%}">
            ì‹ ì… ê°œë°œì</p>
          <p>
            <span class="me-1" style="padding-left:20%; background-color:#EAEAEA;"></span>
            <span class="me-1" style="padding-left:20%; background-color:#EAEAEA;"></span>
            <span class="me-1" style="padding-left:20%; background-color:#EAEAEA;"></span>
            <span class="me-1" style="padding-left:20%; background-color:#EAEAEA;"></span>
            <span class="me-1" style="padding-left:20%; background-color:#EAEAEA;"></span>
          </p>
        {% else %}
          <div>
            <!-- 1~4ë…„ì°¨ -->
            {% if delta.years > 0 and delta.years < 5 %}
              <p class="text-center fw-bold mt-3"><img style='height:45px;width:45px;' src="{% static '/images/1.png'%}">{{ delta.years }}ë…„
                {{delta.months}}ê°œì›” ê²½ë ¥, ì´ˆê¸‰ ê°œë°œì</p>
              <span class="me-1" style="padding-left:20%; background-color:#7689DE;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#EAEAEA;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#EAEAEA;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#EAEAEA;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#EAEAEA;"></span>
              <!-- 5~8ë…„ì°¨ -->
            {% elif delta.years > 4 and delta.years < 9 %}
              <p class="text-center fw-bold mt-3"><img style='height:45px;width:45px;' src="{% static '/images/2.png'%}">
                {{ delta.years }}ë…„ ê²½ë ¥, ì¤‘ê¸‰ ê°œë°œì</p>
              <span class="me-1" style="padding-left:20%; background-color:#7689DE;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#7689DE;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#EAEAEA;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#EAEAEA;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#EAEAEA;"></span>
              <!-- 9~12ë…„ì°¨ -->
            {% elif delta.years > 8 and delta.years < 13 %}
              <p class="text-center fw-bold mt-3"><img style='height:45px;width:45px;' src="{% static '/images/3.png'%}">
                {{ delta.years }}ë…„ ê²½ë ¥, ê³ ê¸‰ ê°œë°œì</p>
              <span class="me-1" style="padding-left:20%; background-color:#7689DE;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#7689DE;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#7689DE;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#EAEAEA;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#EAEAEA;"></span>
              <!-- 13~16ë…„ì°¨ -->
            {% elif delta.years > 12 and delta.years < 17 %}
              <p class="text-center fw-bold mt-3"><img style='height:45px;width:45px;' src="{% static '/images/4.png'%}">
                {{ delta.years }}ë…„ ê²½ë ¥, ê³ ê¸‰ ê°œë°œì/ê´€ë¦¬ì</p>
              <span class="me-1" style="padding-left:20%; background-color:#7689DE;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#7689DE;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#7689DE;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#7689DE;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#EAEAEA;"></span>
              <!-- 17ë…„ ì´ìƒ -->
            {% else %}
              <p class="text-center fw-bold mt-3"><img style='height:45px;width:45px;' src="{% static '/images/5.png'%}">
                {{ delta.years }}ë…„ ê²½ë ¥, ê³ ê¸‰ ê°œë°œì/ê´€ë¦¬ì/ì„ì›</p>
              <span class="me-1" style="padding-left:20%; background-color:#7689DE;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#7689DE;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#7689DE;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#7689DE;"></span>
              <span class="me-1" style="padding-left:20%; background-color:#7689DE;"></span>
            {% endif %}
          </div>
        {% endif %}
      </div>

      <!-- ì˜¤ë¥¸ìª½ í™”ë©´ -->

      <div class="col-6 ms-5">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active text-muted" id="home-article" data-bs-toggle="tab" data-bs-target="#article-tab-pane" type="button" role="tab" aria-controls="article-tab-pane" aria-selected="true">
              ì‘ì„± ê¸€ <span class="badge text-bg-secondary">{{ user.post_set.count }}</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link text-muted" id="comment-tab" data-bs-toggle="tab" data-bs-target="#comment-tab-pane" type="button" role="tab" aria-controls="comment-tab-pane" aria-selected="false">
              ì‘ì„± ëŒ“ê¸€ <span class="badge text-bg-secondary">{{ user.comment_set.count }}</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link text-muted" id="bookmark-tab" data-bs-toggle="tab" data-bs-target="#bookmark-tab-pane" type="button" role="tab" aria-controls="bookmark-tab-pane" aria-selected="false">
              ì¢‹ì•„ìš”í•œ ê¸€ <span class="badge text-bg-secondary">{{ like_posts_ls.count }}</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link text-muted" id="artbookmark-tab" data-bs-toggle="tab" data-bs-target="#artbookmark-tab-pane" type="button" role="tab" aria-controls="artbookmark-tab-pane" aria-selected="false">
              ë¶ë§ˆí¬í•œ ê¸€
              <span class="badge text-bg-secondary">{{ bookmark_articles.count }}</span>
            </button>
          </li>
        </ul>

        <!-- ì‚¬ìš©ìê°€ ì‘ì„±í•œ ê¸€ -->
        <div class="tab-content mt-2" id="myTabContent">
          <div class="tab-pane fade show active" id="article-tab-pane" role="tabpanel" aria-labelledby="article-tab" tabindex="0">
            <h5 class="main_color2 fw-bold">ì´
              {{ user.post_set.count }}ê°œ</h5>

            {% if user.post_set.count == 0 %}
              <div class="text-muted">ì‘ì„±í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            {% else %}
              <span class="text-muted text-center">
                <table class="table">
                  <thead>
                    <tr class="main_color1">
                      <th scope="col">ì œëª©</th>
                      <th scope="col">ì‘ì„±ì¼ì</th>
                      <th scope="col">íƒœê·¸</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for post in posts %}
                      <tr>
                        <td>
                          <i class="bi bi-pencil-fill"></i>
                          <a href="{% url 'posts:detail' post.pk%}" style="text-decoration: none;" class="text-muted">
                            {{ post.title|truncatechars:20 }}
                          </a>
                        </td>
                        <td>
                          <a href="{% url 'posts:detail' post.pk%}" style="text-decoration: none;" class="text-muted">
                            {{ post.created_at }}
                          </a>
                        </td>
                        <td>
                          <a href="{% url 'posts:detail' post.pk%}" style="text-decoration: none;" class="text-muted">
                            {{ post.tag }}
                          </a>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </span>
            {% endif %}

            <!-- pagenator -->
            <div class="text-center">
              {% if posts.has_previous %}
                <span>
                  <a href="?page={{posts.previous_page_number}}"><img style='height:20px;width:20px;' src="{% static '/images/left.png'%}"></a>
                </span>
              {% endif %}
              <span class="text-muted">{{posts.number}}</span>
              <span class="text-muted">/</span>
              <span class="text-muted">{{posts.paginator.num_pages}}</span>
              {% if posts.has_next %}
                <span>
                  <a href="?page={{posts.next_page_number}}"><img style='height:20px;width:20px;' src="{% static '/images/right.png'%}"></a>
                </span>
              {% endif %}
            </div>
          </div>
          <!-- ì‚¬ìš©ìê°€ ì‘ì„±í•œ ëŒ“ê¸€ -->

          <div class="tab-pane fade mt-2" id="comment-tab-pane" role="tabpanel" aria-labelledby="comment-tab" tabindex="0">
            <h5 class="main_color2 fw-bold">ì´
              {{ user.comment_set.count }}ê°œ</h5>

            {% if user.comment_set.count == 0 %}
              <div class="text-muted">ì‘ì„±í•œ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            {% else %}
              <span class="text-muted text-center">
                <table class="table">
                  <thead>
                    <tr class="main_color1">
                      <th scope="col">ë‚´ìš©</th>
                      <th scope="col">ì‘ì„±ì¼ì</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for comment in comments %}
                      <tr>
                        <td>
                          <i class="bi bi-pencil-fill"></i>
                          <a href="{% url 'posts:detail' comment.article.pk %}" style="text-decoration: none;" class="text-muted">
                            {{ comment.content|truncatechars:20 }}
                          </a>
                        </td>
                        <td>
                          <a href="{% url 'posts:detail' comment.article.pk %}" style="text-decoration: none;" class="text-muted">
                            {{ comment.created_at }}
                          </a>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </span>
            {% endif %}

            <!-- pagenator -->
            <div class="text-center">
              {% if comments.has_previous %}
                <span>
                  <a href="?page={{comments.previous_page_number}}"><img style='height:20px;width:20px;' src="{% static '/images/left.png'%}"></a>
                </span>
              {% endif %}
              <span class="text-muted">{{comments.number}}</span>
              <span class="text-muted">/</span>
              <span class="text-muted">{{comments.paginator.num_pages}}</span>
              {% if comments.has_next %}
                <span>
                  <a href="?page={{comments.next_page_number}}"><img style='height:20px;width:20px;' src="{% static '/images/right.png'%}"></a>
                </span>
              {% endif %}
            </div>
          </div>
          <!-- ì‚¬ìš©ìê°€ ì¢‹ì•„ìš”í•œ ê¸€ -->

          <div class="tab-pane fade mt-2" id="bookmark-tab-pane" role="tabpanel" aria-labelledby="bookmark-tab" tabindex="0">
            <h5 class="main_color2 fw-bold">ì´
              {{ like_posts_ls.count }}ê°œ</h5>

            {% if like_posts_ls.count == 0 %}
              <div class="text-muted">ì¢‹ì•„ìš”í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            {% else %}
              <span class="text-muted text-center">
                <table class="table">
                  <thead>
                    <tr class="main_color1">
                      <th scope="col">ì œëª©</th>
                      <th scope="col">ì‘ì„±ì¼ì</th>
                      <th scope="col">íƒœê·¸</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for lp in like_posts %}
                      <tr>
                        <td>
                          <i class="bi bi-pencil-fill"></i>
                          <a href="{% url 'posts:detail' lp.pk%}" style="text-decoration: none;" class="text-muted">
                            {{ lp.title|truncatechars:20 }}
                          </a>
                        </td>
                        <td>
                          <a href="{% url 'posts:detail' lp.pk%}" style="text-decoration: none;" class="text-muted">
                            {{ lp.created_at }}
                          </a>
                        </td>
                        <td>
                          <a href="{% url 'posts:detail' lp.pk%}" style="text-decoration: none;" class="text-muted">
                            {{ lp.tag }}
                          </a>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </span>
            {% endif %}

            <!-- pagenator -->
            <div class="text-center">
              {% if like_posts.has_previous %}
                <span>
                  <a href="?page={{like_posts.previous_page_number}}"><img style='height:20px;width:20px;' src="{% static '/images/left.png'%}"></a>
                </span>
              {% endif %}
              <span class="text-muted">{{like_posts.number}}</span>
              <span class="text-muted">/</span>
              <span class="text-muted">{{like_posts.paginator.num_pages}}</span>
              {% if like_posts.has_next %}
                <span>
                  <a href="?page={{like_posts.next_page_number}}"><img style='height:20px;width:20px;' src="{% static '/images/right.png'%}"></a>
                </span>
              {% endif %}
            </div>
          </div>

          <!-- ì‚¬ìš©ìê°€ ë¶ë§ˆí¬í•œ ê¸€ -->

          <div class="tab-pane fade mt-2" id="artbookmark-tab-pane" role="tabpanel" aria-labelledby="artbookmark-tab" tabindex="0">
            <h5 class="main_color2 fw-bold">ì´
              {{ bookmark_articles.count }}ê°œ</h5>

            {% if bookmark_articles.count == 0 %}
              <div class="text-muted">ìŠ¤í¬ë©í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            {% else %}
              <!-- í…Œì´ë¸” ì¶œë ¥ -->
              <span class="text-muted text-center">
                <table class="table">
                  <thead>
                    <tr class="main_color1">
                      <th scope="col">íšŒì‚¬ëª…</th>
                      <th scope="col">í¬ì§€ì…˜</th>
                      <th scope="col">ì„¸ë¶€ì§ë¬´</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for bookmark in bookmark_articles %}
                      <tr>
                        <td>
                          <i class="bi bi-pencil-fill"></i>
                          <a href="{% url 'articles:detail' bookmark.pk%}" style="text-decoration: none;" class="text-muted">
                            {{ bookmark.job_name|truncatechars:20 }}
                          </a>
                        </td>
                        <td>
                          <a href="{% url 'articles:detail' bookmark.pk%}" style="text-decoration: none;" class="text-muted">
                            {{ bookmark.position|truncatechars:20 }}
                          </a>
                        </td>
                        <td>
                          <a href="{% url 'articles:detail' bookmark.pk%}" style="text-decoration: none;" class="text-muted">
                            {{ bookmark.pseudo_position|truncatechars:20 }}
                          </a>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </span>
            {% endif %}

          </div>
        </div>
      </div>
    </div>
  </div>

<!-- ë²„íŠ¼ ê·¸ë£¹ -->
<p class="text-center mt-4">
<a class="btn btn-outline-primary" href="{% url 'accounts:update' %}">ìˆ˜ì •</a>
<a class="btn btn-outline-success" href="{% url 'accounts:change_password' %}">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</a>
<a class="btn login_btn" href="{% url 'articles:index' %}">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
<!-- Button trigger modal -->
<button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#exampleModal">
íšŒì›íƒˆí‡´
</button>

</p>
</div>
</div>
</div>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-body text-muted" id="exampleModalLabel">
          ì •ë§ë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
          íƒˆí‡´í•˜ì‹œë©´ ì´ì œê¹Œì§€ ìŒ“ì•„ì˜¨ ë°ì´í„°ëŠ” ëª¨ë‘ ë‚ ì•„ê°€ìš”.ğŸ˜¥
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="text-center py-3">
        <button type="button" class="btn login_btn" data-bs-dismiss="modal">ì•„ë‹ˆìš”</button>
        {% if request.user.login_method == 'email' %}
          <a class="btn btn-secondary" href="{% url 'accounts:pw_check' request.user.pk%}">ì˜ˆ</a>
        {% else %}
          <a class="btn btn-secondary" href="{% url 'accounts:delete' request.user.pk%}">ì˜ˆ</a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block script %}
<script>
const form = document.querySelector('#follow-form')
const csrftoken = document
.querySelector('[name=csrfmiddlewaretoken]')
.value

form
.addEventListener('submit', function (event) {
event.preventDefault()
const userId = event
  .target
  .dataset
  .userId

  axios({
    method: 'post',
    url: `/accounts/${userId}/followers/`,
    headers: {
      'X-CSRFToken': csrftoken
    }
  })
  .then((response) => {
    const isFollowed = response.data.is_followed
    const followBtn = document.querySelector('#follow-form > input[type=submit]')
    if (isFollowed === true) {
      followBtn.value = 'ì´ ì‚¬ìš©ìë¥¼ UnFollow í•˜ê² ì–´ìš”.';
      followBtn
        .classList
        .add('login_btn');
      followBtn
        .classList
        .remove('signup_btn');
    } else {
      followBtn.value = 'ì´ ì‚¬ìš©ìë¥¼ Follow í• ë˜ìš”!';
      followBtn
        .classList
        .add('signup_btn');
      followBtn
        .classList
        .remove('login_btn');
    }

    const followersCountTag = document.querySelector('#followings-count')
    const followingsCountTag = document.querySelector('#followers-count')
    const followersCount = response.data.followers_count
    const followingsCount = response.data.followings_count
    followersCountTag.innerText = followersCount
    followingsCountTag.innerText = followingsCount
  })
  .catch((error) => {
    console.log(error.response)
  })
})
</script>

{% endblock script %}